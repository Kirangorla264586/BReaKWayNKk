<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-sidebar sidebar-support">
    <div class="sidebar-header">
      <h1>
        <span>BREAKWAY</span><br><span>SUPPORT</span>
      </h1>
      <img src="gas.png" alt="Breakway Gas Supply Logo" class="sidebar-logo">
    </div>
  </div>
  <div class="page-content">
    <div class="card" style="max-width: 900px; width: 95%; text-align: left">
      <div class="page-header">
        <a href="login.html" id="logoutBtn" class="btn-logout">Logout</a>
      </div>
      <div class="card-header" style="text-align: center;">
        <h2>Support Desk</h2>
        <p>Manage all open and resolved customer support tickets.</p>
      </div>
      <div class="admin-section support-desk">
        <h3>Open Tickets</h3>
        <div id="ticketsList">Loading…</div>
      </div>
    </div>
  </div>
  <button id="themeToggleBtn" class="theme-toggle" aria-label="Toggle theme"></button>
  <script src="main.js"></script>
  <script>
    function readTickets(){
      try{ return JSON.parse(localStorage.getItem('supportTickets')||'[]') || []; }catch(e){ return []; }
    }
    function writeTickets(list){ try{ localStorage.setItem('supportTickets', JSON.stringify(list)); }catch(e){ console.warn('could not save tickets', e); } }
    function renderTickets(){
      var list = readTickets();
      var out = '';
      if (!list.length) { out = '<p class="text-muted">No tickets yet.</p>'; document.getElementById('ticketsList').innerHTML = out; return; }
      list.slice().reverse().forEach(function(t){
        out += `<div class="ticket-item-full">`;
        out += '  <div class="ticket-header">';
        out += '    <div class="ticket-info"><h4>' + escapeHtml(t.name) + '</h4><div class="ticket-meta">' + escapeHtml(t.contact || '') + '</div></div>';
        out += '    <div class="ticket-status status-' + (t.status||'open') + '">' + (t.status||'open') + '</div>';
        out += '    <div class="ticket-actions">';
        if (t.status !== 'resolved') out += '<button data-action="resolve" data-id="'+t.id+'" class="btn-action resolve">Resolve</button>';
        out += '      <button data-action="delete" data-id="'+t.id+'" class="btn-action delete">Delete</button>';
        out += '    </div>';
        out += '  </div>';
        out += '  <div class="chat-messages" style="margin-top: 10px;">';
        if (t.thread && t.thread.length > 0) {
          out += t.thread.map(function(m) {
            return '<div class="chat-msg '+(m.from==='agent'?'agent':'customer')+'"><div class="chat-bubble">'+escapeHtml(m.text)+'</div><div class="chat-meta">'+(m.from==='agent'?'Support':'Customer')+' · '+(new Date(m.at)).toLocaleString()+'</div></div>';
          }).join('');
        } else {
          out += '<p class="text-muted" style="padding: 10px;">No messages yet.</p>';
        }
        out += '  </div>';
        if (t.status !== 'resolved') {
          out += '  <form class="reply-form" data-id="'+t.id+'"><input placeholder="Reply as agent..." autocomplete="off" /><button class="btn btn-submit">Send</button></form>';
        }
        out += `</div>`;
      });
      document.getElementById('ticketsList').innerHTML = out;
      // Attach listeners to the new reply forms
      attachReplyListeners();
    }
    function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]; }); }
    document.addEventListener('click', function(e){
      var btn = e.target.closest('button[data-action]');
      if (btn){
        var id = btn.getAttribute('data-id');
        var action = btn.getAttribute('data-action');
        var list = readTickets();
        var idx = list.findIndex(function(x){ return x.id === id; });
        if (action === 'resolve' && idx !== -1){ list[idx].status = 'resolved'; writeTickets(list); renderTickets(); }
        if (action === 'delete' && idx !== -1){ if(confirm('Are you sure?')) { list.splice(idx,1); writeTickets(list); renderTickets(); } }
        return;
      }
    });

    // Listen for changes from other tabs
    window.addEventListener('storage', function(e) {
      if (e.key === 'supportTickets') {
        // Re-render the entire list to show new messages
        renderTickets();
      }
    });

    function attachReplyListeners() {
      document.querySelectorAll('.reply-form').forEach(function(form) {
        // Prevent multiple listeners by removing old ones first
        form.replaceWith(form.cloneNode(true));
      });
      // Add new listeners
      document.querySelectorAll('.reply-form').forEach(function(form) {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          var id = this.dataset.id;
          if (!id) return;
          var input = this.querySelector('input');
          var text = input.value.trim();
          if (!text) return;
          var list = readTickets();
          var t = list.find(function(x){ return x.id === id; });
          if (!t) return;
          t.thread = t.thread || [];
          t.thread.push({ from:'agent', text: text, at: new Date().toISOString() });
          writeTickets(list);
          input.value = '';
          renderTickets(); // Re-render everything to show the new message
        });
      });
    }
    document.addEventListener('DOMContentLoaded', renderTickets);
  </script>
</body>
</html>